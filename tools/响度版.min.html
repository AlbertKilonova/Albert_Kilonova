<!DOCTYPE html><html><head><title>音频波形可视化（支持录制）</title><style>body{display:flex;flex-direction:column;align-items:center;background:#1a1a1a;color:white;margin:0;min-height:100vh}canvas{background:#000;margin:20px;border-radius:5px}input[type="file"],button{margin:10px;padding:10px 20px;background:#666;border:none;border-radius:5px;color:white;cursor:pointer}#audioCtrl{display:none;margin-bottom:20px}</style></head><body><input type="file" id="audioUpload" accept="audio/*"><button id="recordButton">开始录制</button><audio id="audioCtrl" controls></audio><canvas id="visualizer"></canvas><script>const canvas=document.getElementById('visualizer'),ctx=canvas.getContext('2d'),audioElement=document.getElementById('audioCtrl'),fileInput=document.getElementById('audioUpload'),recordButton=document.getElementById('recordButton');canvas.width=1080,canvas.height=300;const WAVE_COPIES=75,DELAY_FRAMES=1,BASE_BAR_WIDTH=1;let historyBuffers=[],audioContext,analyser,dataArray,mediaRecorder,recordedChunks=[],isRecording=!1;fileInput.addEventListener('change',e=>{const t=e.target.files[0],n=URL.createObjectURL(t);audioElement.src=n,audioElement.style.display='block',initAudioContext()});function initAudioContext(){audioContext=new (window.AudioContext||window.webkitAudioContext)(),analyser=audioContext.createAnalyser(),analyser.fftSize=512;const e=audioContext.createMediaElementSource(audioElement);e.connect(analyser),analyser.connect(audioContext.destination),dataArray=new Uint8Array(analyser.frequencyBinCount),initHistoryBuffers(),draw()}function initHistoryBuffers(){historyBuffers=[];const e=WAVE_COPIES*DELAY_FRAMES;for(let t=0;t<e;t++)historyBuffers.push(new Uint8Array(analyser.frequencyBinCount))}function draw(){requestAnimationFrame(draw);if(!analyser)return;analyser.getByteTimeDomainData(dataArray),historyBuffers.push([...dataArray]),historyBuffers.shift(),ctx.fillStyle='#000',ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle='#fff';const e=canvas.width/WAVE_COPIES;for(let t=0;t<WAVE_COPIES;t++){const n=historyBuffers[t*DELAY_FRAMES]||dataArray,o=t*e,a=e*BASE_BAR_WIDTH/n.length;let l=o;for(let e=0;e<n.length;e++){const t=n[e]/128-1,c=Math.abs(t)*canvas.height/2;ctx.fillRect(l,canvas.height/2-c,a+5,2*c),l+=a*0}}}recordButton.addEventListener('click',()=>{isRecording?(mediaRecorder.stop(),recordButton.textContent='开始录制',isRecording=!1):startRecording()});async function startRecording(){try{const e=canvas.captureStream(30),t=audioElement.captureStream(),n=new MediaStream([...e.getVideoTracks(),...t.getAudioTracks()]);mediaRecorder=new MediaRecorder(n,{mimeType:'video/webm;codecs=vp9,opus'}),mediaRecorder.ondataavailable=e=>{e.data.size>0&&recordedChunks.push(e.data)},mediaRecorder.onstop=()=>{const e=new Blob(recordedChunks,{type:'video/webm'}),t=URL.createObjectURL(e),n=document.createElement('a');n.href=t,n.download='recording.webm',n.click(),recordedChunks=[]},mediaRecorder.start(),recordButton.textContent='停止录制',isRecording=!0}catch(e){alert('录制失败: '+e.message)}}</script></body></html>